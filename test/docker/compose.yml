version: "3.9"
services:
  mocks:
    image: outofcoffee/imposter
    volumes:
      - "../imposter:/opt/imposter/config"
    ports:
      - "8010:8080"
    networks:
      - toy-network

  #  core-stub:
  #    image: ghcr.io/alphagov/di/di-ipv-core-stub:latest
  #    environment:
  #      CORE_STUB_CONFIG_FILE: "/app/di-ipv-config.yaml"
  #      CORE_STUB_KEYSTORE_ALIAS: ipv-core-stub
  #      CORE_STUB_KEYSTORE_PASSWORD: "puppet"
  #      CORE_STUB_KEYSTORE_FILE: "/app/keystore.jks"
  #      CORE_STUB_USER_DATA_PATH: "/app/experian-uat-users-large.zip"
  #    volumes:
  #      - "./di-ipv-config.yaml:/app/di-ipv-config.yaml"
  #      - "${CORE_STUB_CONFIG_DIRECTORY}/keystore.jks:/app/keystore.jks"
  #      - "${CORE_STUB_CONFIG_DIRECTORY}/experian-uat-users-large.zip:/app/experian-uat-users-large.zip"
  #    ports:
  #      - "8085:8085"
  web:
    build:
      context: ../..
      dockerfile: local.Dockerfile
    environment:
      REDIS_SESSION_URL: db
      API_BASE_URL: http://172.17.0.1:8010
      #      API_BASE_URL: http://mocks:8010
      PORT: 5050
      NODE_ENV: development
    ports:
      - "5050:5050"
    networks:
      - toy-network
    #    healthcheck:
    #      test: ["CMD", "curl","-I", "http://127.20.0.3:5050"]
    #      interval: 10s
    #      timeout: 5s
    #      retries: 3
    #      start_period: 5s

    depends_on:
      - mocks
    #      - core-stub
    links:
      - mocks

  cucumber:
    build:
      context: ../
      dockerfile: docker/Dockerfile
    environment:
      MOCK_API: true
      WEBSITE_HOST: http://172.20.0.3:5050
    depends_on:
      - web
    #        condition: service_healthy
    networks:
      - toy-network
#      volumes:
#        -  ../browser:/cucumber/test/browser

networks:
  toy-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16
